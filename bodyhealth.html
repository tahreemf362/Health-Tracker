<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Body Health Tracker - WellNest</title>
  <link rel="stylesheet" href="style.css?v=20241005">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Force Cache Clear Script -->
  <script>
    // Clear all caches on load to prevent old version issues
    if ('caches' in window) {
      caches.keys().then(function(names) {
        names.forEach(function(name) {
          if (name.indexOf('wellnest') !== -1 && name.indexOf('v3-fixed') === -1) {
            caches.delete(name).then(() => {
              console.log('Body Health page: Cleared old cache:', name);
            });
          }
        });
      });
    }
    
    // Force reload if cached version detected  
    if (performance.navigation.type === 1 && !sessionStorage.getItem('bodyhealth-refresh-done')) {
      sessionStorage.setItem('bodyhealth-refresh-done', 'true');
      location.reload(true);
    }
  </script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="images/fitness-logo.svg" alt="WellNest Logo" class="logo">
        <span>WellNest</span>
      </div>
      
      <ul class="nav-menu" id="navMenu">
        <li><a href="index.html">Home</a></li>
        <li><a href="body.html">Body</a></li>
        <li><a href="bodyhealth.html" class="active">Body Health</a></li>
        <li><a href="mind.html">Mind</a></li>
        <li><a href="sleep.html">Sleep</a></li>
        <li><a href="diet.html">Diet</a></li>
        <li><a href="workout.html">Workout</a></li>
        <li><a href="care.html">Care</a></li>
        <li><a href="pray.html">Prayer</a></li>
        <li><a href="reminders.html">Reminders</a></li>
        <li><a href="login.html" id="loginLink">Login</a></li>
        <li><a href="signup.html" id="signupLink">Sign Up</a></li>
        <li><a href="#" id="logoutLink" onclick="logout()" style="display: none;">Logout</a></li>
      </ul>
      
      <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section bodyhealth-hero">
    <div class="hero-content">
      <h1>Body Health Tracker üí™</h1>
      <p>Comprehensive health monitoring and wellness insights</p>
    </div>
  </section>

  <main class="main-content">
    <div class="container">

      <!-- Blood Pressure Tracker -->
      <div class="care-card">
        <h3>ü©∏ Blood Pressure Monitor</h3>
        <div class="health-input-group">
          <div class="input-row">
            <div class="input-field">
              <label>Systolic (mmHg):</label>
              <input type="number" id="systolic" placeholder="e.g. 120">
            </div>
            <div class="input-field">
              <label>Diastolic (mmHg):</label>
              <input type="number" id="diastolic" placeholder="e.g. 80">
            </div>
          </div>
          <button class="health-btn" onclick="checkBP()">Check Blood Pressure</button>
          <div class="result-card" id="bpResult"></div>
          <button class="secondary-btn">üì± Connect Device (Coming Soon)</button>
        </div>
      </div>

      <!-- Blood Sugar Tracker -->
      <div class="care-card">
        <h3>üçØ Blood Sugar Monitor</h3>
        <div class="health-input-group">
          <div class="input-field">
            <label>Glucose Level (mg/dL):</label>
            <input type="number" id="glucose" placeholder="e.g. 100">
          </div>
          <button class="health-btn" onclick="checkSugar()">Check Blood Sugar</button>
          <div class="result-card" id="sugarResult"></div>
        </div>
      </div>

      <!-- BMI Calculator -->
      <div class="care-card">
        <h3>‚öñÔ∏è BMI Calculator</h3>
        <div class="health-input-group">
          <div class="input-row">
            <div class="input-field">
              <label>Height (cm):</label>
              <input type="number" id="height" placeholder="e.g. 165">
            </div>
            <div class="input-field">
              <label>Weight (kg):</label>
              <input type="number" id="weight" placeholder="e.g. 60">
            </div>
          </div>
          <button class="health-btn" onclick="calcBMI()">Calculate BMI</button>
          <div class="result-card" id="bmiResult"></div>
        </div>
      </div>

      <!-- Health Activity Calendar -->
      <div class="care-card calendar-card" style="display: block; opacity: 1;">
        <h3>üìÖ Health Activity Calendar</h3>
        <div class="calendar-section">
          <div class="calendar-header">
            <button class="nav-btn" onclick="changeMonth(-1)">‚ùÆ</button>
            <h4 id="currentMonth">October 2025</h4>
            <button class="nav-btn" onclick="changeMonth(1)">‚ùØ</button>
          </div>
          
          <div class="calendar-grid">
            <div class="calendar-days">
              <div class="day-header">Sun</div>
              <div class="day-header">Mon</div>
              <div class="day-header">Tue</div>
              <div class="day-header">Wed</div>
              <div class="day-header">Thu</div>
              <div class="day-header">Fri</div>
              <div class="day-header">Sat</div>
            </div>
            <div class="calendar-dates" id="calendarDates">
              <!-- Static calendar as fallback -->
              <div class="calendar-day">1</div>
              <div class="calendar-day">2</div>
              <div class="calendar-day">3</div>
              <div class="calendar-day">4</div>
              <div class="calendar-day today">5</div>
              <div class="calendar-day">6</div>
              <div class="calendar-day">7</div>
              <div class="calendar-day">8</div>
              <div class="calendar-day">9</div>
              <div class="calendar-day">10</div>
              <div class="calendar-day">11</div>
              <div class="calendar-day">12</div>
              <div class="calendar-day">13</div>
              <div class="calendar-day">14</div>
              <div class="calendar-day">15</div>
              <div class="calendar-day">16</div>
              <div class="calendar-day">17</div>
              <div class="calendar-day">18</div>
              <div class="calendar-day">19</div>
              <div class="calendar-day">20</div>
              <div class="calendar-day">21</div>
              <div class="calendar-day">22</div>
              <div class="calendar-day">23</div>
              <div class="calendar-day">24</div>
              <div class="calendar-day">25</div>
              <div class="calendar-day">26</div>
              <div class="calendar-day">27</div>
              <div class="calendar-day">28</div>
              <div class="calendar-day">29</div>
              <div class="calendar-day">30</div>
              <div class="calendar-day">31</div>
            </div>
          </div>
          
          <div class="calendar-legend">
            <div class="legend-item">
              <span class="legend-dot excellent"></span>
              <span>Excellent Day (90-100%)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot good"></span>
              <span>Good Day (70-89%)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot average"></span>
              <span>Average Day (50-69%)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot poor"></span>
              <span>Needs Improvement (<50%)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Counter -->
      <div class="care-card">
        <h3>üö∂‚Äç‚ôÄÔ∏è Daily Step Counter</h3>
        <div class="step-display">
          <div class="step-number" id="steps">0</div>
          <div class="step-label">steps today</div>
        </div>
        <div class="progress-container">
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="stepBar">0%</div>
          </div>
          <div class="progress-text">Goal: 10,000 steps</div>
        </div>
        <button class="health-btn" onclick="addSteps()">+ Add Steps</button>
      </div>

      <!-- Heart Rate Monitor -->
      <div class="care-card">
        <h3>‚ù§Ô∏è Heart Rate Monitor</h3>
        <div class="heart-monitor">
          <div class="heart-pulse" id="heartPulse">
            <div class="pulse-animation"></div>
          </div>
          <button class="health-btn" onclick="simulateHeartRate()">Measure Heart Rate</button>
          <div class="result-card" id="heartResult"></div>
        </div>
      </div>

      <!-- Health Summary -->
      <div class="care-card">
        <h3>üìä Health Summary</h3>
        <div class="health-summary" id="healthSummary">
          <div class="summary-item">
            <span class="summary-label">Overall Health Score:</span>
            <span class="summary-value" id="healthScore">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Last Check:</span>
            <span class="summary-value" id="lastCheck">Never</span>
          </div>
          <div class="recommendations" id="recommendations">
            <h4>üí° Recommendations:</h4>
            <ul id="recommendationsList">
              <li>Complete a health check to get personalized recommendations</li>
            </ul>
          </div>
        </div>
      </div>



      <!-- Daily Activity Panel -->
      <div class="care-card daily-panel" id="dailyPanel" style="display: none;">
        <h3 id="selectedDate">Today's Activities</h3>
        <div class="activity-tabs">
          <button class="tab-btn active" onclick="showTab('overview')">üìä Overview</button>
          <button class="tab-btn" onclick="showTab('activities')">üèÉ‚Äç‚ôÄÔ∏è Activities</button>
          <button class="tab-btn" onclick="showTab('health')">ü©∫ Health</button>
          <button class="tab-btn" onclick="showTab('suggestions')">üí° AI Suggestions</button>
        </div>
        
        <div class="tab-content active" id="overview">
          <div class="daily-score">
            <div class="score-circle">
              <span id="dailyScore">-</span>
              <small>Health Score</small>
            </div>
          </div>
          <div class="quick-stats">
            <div class="stat-item">
              <span class="stat-number" id="dailySteps">0</span>
              <span class="stat-label">Steps</span>
            </div>
            <div class="stat-item">
              <span class="stat-number" id="activitiesCompleted">0</span>
              <span class="stat-label">Activities</span>
            </div>
            <div class="stat-item">
              <span class="stat-number" id="healthChecks">0</span>
              <span class="stat-label">Health Checks</span>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="activities">
          <div class="activity-tracker">
            <h4>Track Your Activities</h4>
            <div class="activity-list">
              <div class="activity-item">
                <label class="activity-checkbox">
                  <input type="checkbox" onchange="updateActivity('exercise', this.checked)">
                  <span class="checkmark">üí™</span>
                  <span class="activity-name">Exercise/Workout</span>
                </label>
              </div>
              <div class="activity-item">
                <label class="activity-checkbox">
                  <input type="checkbox" onchange="updateActivity('meditation', this.checked)">
                  <span class="checkmark">üßò‚Äç‚ôÄÔ∏è</span>
                  <span class="activity-name">Meditation/Mindfulness</span>
                </label>
              </div>
              <div class="activity-item">
                <label class="activity-checkbox">
                  <input type="checkbox" onchange="updateActivity('water', this.checked)">
                  <span class="checkmark">üíß</span>
                  <span class="activity-name">Drank 8+ Glasses Water</span>
                </label>
              </div>
              <div class="activity-item">
                <label class="activity-checkbox">
                  <input type="checkbox" onchange="updateActivity('sleep', this.checked)">
                  <span class="checkmark">üò¥</span>
                  <span class="activity-name">Got 7-9 Hours Sleep</span>
                </label>
              </div>
              <div class="activity-item">
                <label class="activity-checkbox">
                  <input type="checkbox" onchange="updateActivity('healthy_meal', this.checked)">
                  <span class="checkmark">ü•ó</span>
                  <span class="activity-name">Ate Healthy Meals</span>
                </label>
              </div>
              <div class="activity-item">
                <label class="activity-checkbox">
                  <input type="checkbox" onchange="updateActivity('vitamins', this.checked)">
                  <span class="checkmark">üíä</span>
                  <span class="activity-name">Took Vitamins/Supplements</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="health">
          <div class="health-metrics">
            <h4>Health Metrics Recorded</h4>
            <div id="healthMetricsDisplay">
              <p class="no-data">No health metrics recorded for this day.</p>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="suggestions">
          <div class="ai-suggestions">
            <h4>ü§ñ AI-Powered Suggestions</h4>
            <div id="aiSuggestionsDisplay">
              <!-- AI suggestions will be generated here -->
            </div>
          </div>
        </div>
        
        <div class="panel-actions">
          <button class="health-btn" onclick="saveDaily()">üíæ Save Today's Data</button>
          <button class="secondary-btn" onclick="closeDailyPanel()">‚úï Close</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Authentication check
    function checkAuthentication() {
      const isLoggedIn = localStorage.getItem('wellnest_user');
      if (!isLoggedIn || isLoggedIn !== 'true') {
        alert('Please login to access health monitoring features! üíä');
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // Navigation functions
    function updateNavigation() {
      const isLoggedIn = localStorage.getItem('wellnest_user');
      if (isLoggedIn === 'true') {
        document.getElementById('loginLink').style.display = 'none';
        document.getElementById('signupLink').style.display = 'none';
        document.getElementById('logoutLink').style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('wellnest_user');
      localStorage.removeItem('wellnest_user_data');
      alert('Logged out successfully! See you soon! üëã');
      window.location.href = 'index.html';
    }

    // Blood Pressure checker
    function checkBP() {
      const s = parseInt(document.getElementById("systolic").value);
      const d = parseInt(document.getElementById("diastolic").value);
      let res = "", color = "";
      
      if (!s || !d) {
        res = "‚ö†Ô∏è Please enter both values!";
        color = "#ff9800";
      } else if (s < 90 || d < 60) {
        res = "üîµ Low BP - Consider drinking more fluids and rest";
        color = "#2196f3";
      } else if (s > 140 || d > 90) {
        res = "üî¥ High BP - Reduce salt intake and manage stress";
        color = "#f44336";
      } else {
        res = "‚úÖ Normal BP - Great! Keep maintaining healthy habits";
        color = "#4caf50";
      }
      
      document.getElementById("bpResult").innerHTML = `
        <div class="result-display" style="border-color: ${color}">
          <div class="result-text">${res}</div>
          <div class="result-values">Systolic: ${s} | Diastolic: ${d}</div>
        </div>
      `;
      updateHealthScore();
    }

    // Blood Sugar checker
    function checkSugar() {
      const g = parseInt(document.getElementById("glucose").value);
      let res = "", color = "";
      
      if (!g) {
        res = "‚ö†Ô∏è Please enter glucose value!";
        color = "#ff9800";
      } else if (g < 70) {
        res = "üîµ Low Blood Sugar - Have something sweet immediately üçØ";
        color = "#2196f3";
      } else if (g > 140) {
        res = "üî¥ High Blood Sugar - Avoid sugary foods today";
        color = "#f44336";
      } else {
        res = "‚úÖ Normal Blood Sugar - Excellent! Maintain balanced diet";
        color = "#4caf50";
      }
      
      document.getElementById("sugarResult").innerHTML = `
        <div class="result-display" style="border-color: ${color}">
          <div class="result-text">${res}</div>
          <div class="result-values">Glucose: ${g} mg/dL</div>
        </div>
      `;
      updateHealthScore();
    }

    // BMI Calculator
    function calcBMI() {
      const h = parseFloat(document.getElementById("height").value) / 100;
      const w = parseFloat(document.getElementById("weight").value);
      
      if (!h || !w) {
        document.getElementById("bmiResult").innerHTML = 
          '<div class="result-display" style="border-color: #ff9800">‚ö†Ô∏è Please enter both height and weight!</div>';
        return;
      }
      
      const bmi = (w / (h * h)).toFixed(1);
      let res = "", color = "", category = "";
      
      if (bmi < 18.5) {
        res = `BMI: ${bmi} - Underweight`;
        category = "Consider gaining healthy weight ü•ó";
        color = "#2196f3";
      } else if (bmi < 25) {
        res = `BMI: ${bmi} - Normal Weight`;
        category = "Perfect! Maintain current lifestyle ‚úÖ";
        color = "#4caf50";
      } else if (bmi < 30) {
        res = `BMI: ${bmi} - Overweight`;
        category = "Consider healthy weight loss üèÉ‚Äç‚ôÄÔ∏è";
        color = "#ff9800";
      } else {
        res = `BMI: ${bmi} - Obese`;
        category = "Consult healthcare provider üè•";
        color = "#f44336";
      }
      
      document.getElementById("bmiResult").innerHTML = `
        <div class="result-display" style="border-color: ${color}">
          <div class="result-text">${res}</div>
          <div class="result-values">${category}</div>
        </div>
      `;
      updateHealthScore();
    }

    // Step Counter
    let stepCount = parseInt(localStorage.getItem('dailySteps')) || 0;
    
    function addSteps() {
      const newSteps = Math.floor(Math.random() * 500) + 100;
      stepCount += newSteps;
      updateStepDisplay();
      localStorage.setItem('dailySteps', stepCount);
    }
    
    function updateStepDisplay() {
      const percent = Math.min((stepCount / 10000) * 100, 100);
      document.getElementById("steps").textContent = stepCount.toLocaleString();
      document.getElementById("stepBar").style.width = percent + "%";
      document.getElementById("stepBar").textContent = Math.floor(percent) + "%";
    }

    // Heart Rate Monitor
    function simulateHeartRate() {
      const heartAnimation = document.querySelector('.pulse-animation');
      if (heartAnimation) heartAnimation.style.animation = 'heartbeat 1s infinite';
      
      setTimeout(() => {
        const rate = Math.floor(Math.random() * 40) + 60;
        let status = "", color = "";
        
        if (rate < 60) {
          status = "Below normal - Consider medical consultation";
          color = "#2196f3";
        } else if (rate > 100) {
          status = "Above normal - Try relaxation techniques";
          color = "#ff9800";
        } else {
          status = "Normal resting heart rate ‚úÖ";
          color = "#4caf50";
        }
        
        document.getElementById("heartResult").innerHTML = `
          <div class="result-display" style="border-color: ${color}">
            <div class="result-text">‚ù§Ô∏è ${rate} BPM</div>
            <div class="result-values">${status}</div>
          </div>
        `;
        
        if (heartAnimation) heartAnimation.style.animation = '';
        updateHealthScore();
      }, 2000);
    }

    // Health Score Calculation
    function updateHealthScore() {
      let score = 0;
      let checkCount = 0;
      
      const bpResult = document.getElementById("bpResult").textContent;
      const sugarResult = document.getElementById("sugarResult").textContent;
      const bmiResult = document.getElementById("bmiResult").textContent;
      const heartResult = document.getElementById("heartResult").textContent;
      
      if (bpResult && bpResult.includes("‚úÖ")) { score += 25; checkCount++; }
      if (sugarResult && sugarResult.includes("‚úÖ")) { score += 25; checkCount++; }
      if (bmiResult && bmiResult.includes("‚úÖ")) { score += 25; checkCount++; }
      if (heartResult && heartResult.includes("‚úÖ")) { score += 25; checkCount++; }
      
      if (checkCount > 0) {
        const finalScore = Math.round(score);
        document.getElementById("healthScore").textContent = finalScore + "/100";
        document.getElementById("lastCheck").textContent = new Date().toLocaleDateString();
        
        const recommendations = [];
        if (finalScore >= 75) {
          recommendations.push("Excellent health! Keep up the great work! üåü");
        } else if (finalScore >= 50) {
          recommendations.push("Good health with room for improvement üí™");
        } else {
          recommendations.push("Focus on improving your health metrics üéØ");
        }
        
        if (stepCount < 5000) {
          recommendations.push("Increase daily physical activity");
        }
        
        const list = document.getElementById("recommendationsList");
        list.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
      }
    }

    // Hamburger Menu Functionality
    const hamburger = document.getElementById('hamburger');
    const navMenu = document.getElementById('navMenu');

    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      navMenu.classList.toggle('active');
    });

    document.querySelectorAll('.nav-menu a').forEach(link => {
      link.addEventListener('click', () => {
        hamburger.classList.remove('active');
        navMenu.classList.remove('active');
      });
    });

    // Calendar System
    let currentDate = new Date();
    let selectedDateData = null;

    function generateCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      document.getElementById('currentMonth').textContent = 
        new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate);
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      const calendarDates = document.getElementById('calendarDates');
      calendarDates.innerHTML = '';
      
      // Add empty cells for days before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        calendarDates.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day;
        
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = getDayData(dateKey);
        
        if (dayData) {
          dayElement.classList.add('has-data');
          dayElement.classList.add(getScoreClass(dayData.score));
        }
        
        const today = new Date();
        if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
          dayElement.classList.add('today');
        }
        
        dayElement.onclick = () => selectDate(dateKey, day, month, year);
        calendarDates.appendChild(dayElement);
      }
    }

    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      generateCalendar();
    }

    function selectDate(dateKey, day, month, year) {
      selectedDateData = dateKey;
      const selectedDay = new Date(year, month, day);
      const formattedDate = new Intl.DateTimeFormat('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }).format(selectedDay);
      
      document.getElementById('selectedDate').textContent = `${formattedDate} Activities`;
      document.getElementById('dailyPanel').style.display = 'block';
      loadDayData(dateKey);
      
      // Scroll to daily panel
      document.getElementById('dailyPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function getDayData(dateKey) {
      const userData = JSON.parse(localStorage.getItem('wellnest_user_data') || '{}');
      return userData.calendar && userData.calendar[dateKey] ? userData.calendar[dateKey] : null;
    }

    function saveDayData(dateKey, data) {
      const userData = JSON.parse(localStorage.getItem('wellnest_user_data') || '{}');
      if (!userData.calendar) userData.calendar = {};
      userData.calendar[dateKey] = data;
      localStorage.setItem('wellnest_user_data', JSON.stringify(userData));
    }

    function getScoreClass(score) {
      if (score >= 90) return 'excellent';
      if (score >= 70) return 'good';
      if (score >= 50) return 'average';
      return 'poor';
    }

    function loadDayData(dateKey) {
      const dayData = getDayData(dateKey) || {
        activities: {},
        healthMetrics: {},
        score: 0,
        steps: 0
      };
      
      // Load activities
      Object.keys(dayData.activities || {}).forEach(activity => {
        const checkbox = document.querySelector(`input[onchange*="${activity}"]`);
        if (checkbox) checkbox.checked = dayData.activities[activity];
      });
      
      // Update overview
      document.getElementById('dailyScore').textContent = dayData.score || 0;
      document.getElementById('dailySteps').textContent = dayData.steps || 0;
      document.getElementById('activitiesCompleted').textContent = 
        Object.values(dayData.activities || {}).filter(Boolean).length;
      document.getElementById('healthChecks').textContent = 
        Object.keys(dayData.healthMetrics || {}).length;
      
      // Load health metrics
      loadHealthMetrics(dayData.healthMetrics || {});
      
      // Generate AI suggestions
      generateAISuggestions(dayData);
    }

    function updateActivity(activityName, isCompleted) {
      const dayData = getDayData(selectedDateData) || {
        activities: {},
        healthMetrics: {},
        score: 0,
        steps: 0
      };
      
      dayData.activities[activityName] = isCompleted;
      dayData.score = calculateDayScore(dayData);
      
      saveDayData(selectedDateData, dayData);
      loadDayData(selectedDateData);
      generateCalendar(); // Refresh calendar to show updated score
    }

    function calculateDayScore(dayData) {
      const activities = dayData.activities || {};
      const healthMetrics = dayData.healthMetrics || {};
      
      let score = 0;
      const totalActivities = 6; // Total trackable activities
      const completedActivities = Object.values(activities).filter(Boolean).length;
      
      // Activity score (60% weight)
      score += (completedActivities / totalActivities) * 60;
      
      // Health metrics score (30% weight)
      const healthScore = Object.keys(healthMetrics).length > 0 ? 25 : 0;
      score += healthScore;
      
      // Steps score (10% weight)
      const stepsScore = Math.min((dayData.steps || 0) / 10000, 1) * 15;
      score += stepsScore;
      
      return Math.round(score);
    }

    function loadHealthMetrics(healthMetrics) {
      const display = document.getElementById('healthMetricsDisplay');
      
      if (Object.keys(healthMetrics).length === 0) {
        display.innerHTML = '<p class="no-data">No health metrics recorded for this day.</p>';
        return;
      }
      
      let html = '<div class="metrics-grid">';
      
      Object.entries(healthMetrics).forEach(([metric, value]) => {
        html += `
          <div class="metric-item">
            <span class="metric-name">${getMetricLabel(metric)}</span>
            <span class="metric-value">${value}</span>
          </div>
        `;
      });
      
      html += '</div>';
      display.innerHTML = html;
    }

    function getMetricLabel(metric) {
      const labels = {
        'bp': 'ü©∏ Blood Pressure',
        'glucose': 'üçØ Blood Sugar',
        'bmi': '‚öñÔ∏è BMI',
        'heartRate': '‚ù§Ô∏è Heart Rate'
      };
      return labels[metric] || metric;
    }

    function generateAISuggestions(dayData) {
      const display = document.getElementById('aiSuggestionsDisplay');
      const activities = dayData.activities || {};
      const score = dayData.score || 0;
      
      let suggestions = [];
      
      // Score-based suggestions
      if (score < 50) {
        suggestions.push({
          icon: 'üöÄ',
          text: 'Your health score is below average. Focus on completing more daily activities.',
          priority: 'high'
        });
      } else if (score < 70) {
        suggestions.push({
          icon: 'üìà',
          text: 'Good progress! Try to add one more healthy activity to reach the next level.',
          priority: 'medium'
        });
      } else if (score >= 90) {
        suggestions.push({
          icon: 'üèÜ',
          text: 'Excellent work! You\'re maintaining a fantastic health routine.',
          priority: 'celebration'
        });
      }
      
      // Activity-specific suggestions
      if (!activities.exercise) {
        suggestions.push({
          icon: 'üí™',
          text: 'Add 30 minutes of exercise to boost your energy and mood.',
          priority: 'medium'
        });
      }
      
      if (!activities.water) {
        suggestions.push({
          icon: 'üíß',
          text: 'Stay hydrated! Aim for 8 glasses of water throughout the day.',
          priority: 'high'
        });
      }
      
      if (!activities.sleep) {
        suggestions.push({
          icon: 'üò¥',
          text: 'Prioritize 7-9 hours of quality sleep for better recovery.',
          priority: 'high'
        });
      }
      
      if (!activities.meditation) {
        suggestions.push({
          icon: 'üßò‚Äç‚ôÄÔ∏è',
          text: 'Try 10 minutes of meditation to reduce stress and improve focus.',
          priority: 'low'
        });
      }
      
      // Weekly pattern analysis
      const weekData = getWeekData(selectedDateData);
      if (weekData.avgScore < score) {
        suggestions.push({
          icon: 'üìä',
          text: 'You\'re doing better than your weekly average! Keep up the momentum.',
          priority: 'celebration'
        });
      }
      
      if (suggestions.length === 0) {
        suggestions.push({
          icon: '‚ú®',
          text: 'You\'re doing amazing! Continue your healthy habits.',
          priority: 'celebration'
        });
      }
      
      let html = '<div class="suggestions-list">';
      suggestions.forEach(suggestion => {
        html += `
          <div class="suggestion-item ${suggestion.priority}">
            <span class="suggestion-icon">${suggestion.icon}</span>
            <span class="suggestion-text">${suggestion.text}</span>
          </div>
        `;
      });
      html += '</div>';
      
      display.innerHTML = html;
    }

    function getWeekData(dateKey) {
      const userData = JSON.parse(localStorage.getItem('wellnest_user_data') || '{}');
      const calendar = userData.calendar || {};
      
      const selectedDate = new Date(dateKey);
      let totalScore = 0;
      let daysCount = 0;
      
      for (let i = 0; i < 7; i++) {
        const checkDate = new Date(selectedDate);
        checkDate.setDate(checkDate.getDate() - i);
        const checkKey = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
        
        if (calendar[checkKey]) {
          totalScore += calendar[checkKey].score || 0;
          daysCount++;
        }
      }
      
      return {
        avgScore: daysCount > 0 ? Math.round(totalScore / daysCount) : 0,
        daysCount
      };
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    function saveDaily() {
      if (!selectedDateData) return;
      
      const dayData = getDayData(selectedDateData) || {
        activities: {},
        healthMetrics: {},
        score: 0,
        steps: 0
      };
      
      // Save current step count for the day
      const currentSteps = parseInt(localStorage.getItem('daily_steps') || '0');
      dayData.steps = currentSteps;
      
      // Save health metrics from current session
      const bpResult = document.getElementById('bpResult').innerHTML;
      const sugarResult = document.getElementById('sugarResult').innerHTML;
      const bmiResult = document.getElementById('bmiResult').innerHTML;
      const heartResult = document.getElementById('heartResult').innerHTML;
      
      if (bpResult && !bpResult.includes('‚ö†Ô∏è')) {
        dayData.healthMetrics.bp = bpResult;
      }
      if (sugarResult && !sugarResult.includes('‚ö†Ô∏è')) {
        dayData.healthMetrics.glucose = sugarResult;
      }
      if (bmiResult && !bmiResult.includes('‚ö†Ô∏è')) {
        dayData.healthMetrics.bmi = bmiResult;
      }
      if (heartResult && !heartResult.includes('‚ö†Ô∏è')) {
        dayData.healthMetrics.heartRate = heartResult;
      }
      
      dayData.score = calculateDayScore(dayData);
      saveDayData(selectedDateData, dayData);
      
      alert('‚úÖ Daily data saved successfully!');
      generateCalendar();
      loadDayData(selectedDateData);
    }

    function closeDailyPanel() {
      document.getElementById('dailyPanel').style.display = 'none';
      selectedDateData = null;
    }

    // Initialize page
    function initializePage() {
      if (!checkAuthentication()) return;
      updateNavigation();
      updateStepDisplay();
      
      // Ensure calendar elements exist before generating
      const calendarDates = document.getElementById('calendarDates');
      const currentMonth = document.getElementById('currentMonth');
      
      if (calendarDates && currentMonth) {
        generateCalendar();
      } else {
        // Retry after a short delay if elements aren't ready
        setTimeout(initializePage, 50);
      }
    }

    // Use both DOMContentLoaded and window.onload for maximum compatibility
    document.addEventListener('DOMContentLoaded', initializePage);
    window.addEventListener('load', function() {
      // Fallback initialization if DOMContentLoaded didn't work
      const calendarDates = document.getElementById('calendarDates');
      if (calendarDates && !calendarDates.hasChildNodes()) {
        generateCalendar();
      }
    });
  </script>
</body>
</html>
