<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Reminders - WellNest</title>
  <link rel="stylesheet" href="style.css?v=20241005">
  
  <!-- Force Cache Clear Script -->
  <script>
    // Clear all caches on load to prevent old version issues
    if ('caches' in window) {
      caches.keys().then(function(names) {
        names.forEach(function(name) {
          if (name.indexOf('wellnest') !== -1 && name.indexOf('v3-fixed') === -1) {
            caches.delete(name).then(() => {
              console.log('Reminders page: Cleared old cache:', name);
            });
          }
        });
      });
    }
    
    // Force reload if cached version detected
    if (performance.navigation.type === 1 && !sessionStorage.getItem('reminders-refresh-done')) {
      sessionStorage.setItem('reminders-refresh-done', 'true');
      location.reload(true);
    }
    
    let activeReminders = [];
    let reminderIntervals = [];

    function addTimedReminder() {
      const task = document.getElementById("reminderInput").value;
      const time = document.getElementById("reminderTime").value;
      const type = document.getElementById("reminderType").value;
      
      if (task.trim() === "") return alert("Please enter a reminder task!");
      if (!time) return alert("Please set a time for the reminder!");

      // Enhanced notification permission for app compatibility
      requestEnhancedNotificationPermission();

      const reminder = {
        id: Date.now(),
        task: task,
        time: time,
        type: type,
        active: true,
        created: new Date().toLocaleDateString()
      };

      activeReminders.push(reminder);
      displayReminder(reminder);
      scheduleReminder(reminder);
      
      // Save to localStorage
      localStorage.setItem('activeReminders', JSON.stringify(activeReminders));
      
      // Clear form
      document.getElementById("reminderInput").value = "";
      document.getElementById("reminderTime").value = "";
      document.getElementById("reminderType").value = "once";
    }

    function displayReminder(reminder) {
      const li = document.createElement("li");
      li.className = "reminder-item";
      li.innerHTML = `
        <div class="reminder-content">
          <span class="reminder-icon">üîî</span>
          <div class="reminder-details">
            <strong>${reminder.task}</strong>
            <div class="reminder-time">‚è∞ ${formatTime(reminder.time)} - ${reminder.type}</div>
          </div>
          <button onclick="removeReminder(${reminder.id})" class="remove-btn">‚ùå</button>
        </div>
      `;
      document.getElementById("reminderList").appendChild(li);
    }

    function scheduleReminder(reminder) {
      const now = new Date();
      const [hours, minutes] = reminder.time.split(':').map(Number);
      
      let reminderTime = new Date();
      reminderTime.setHours(hours, minutes, 0, 0);
      
      // If time has passed today, schedule for tomorrow (for once/daily reminders)
      if (reminderTime <= now) {
        if (reminder.type === 'once') {
          reminderTime.setDate(reminderTime.getDate() + 1);
        } else if (reminder.type === 'daily') {
          reminderTime.setDate(reminderTime.getDate() + 1);
        }
      }

      const timeUntilReminder = reminderTime.getTime() - now.getTime();

      if (reminder.type === 'once') {
        setTimeout(() => {
          triggerNotification(reminder);
          removeReminder(reminder.id);
        }, timeUntilReminder);
      } else if (reminder.type === 'daily') {
        setTimeout(() => {
          triggerNotification(reminder);
          // Schedule next day
          scheduleReminder(reminder);
        }, timeUntilReminder);
      } else if (reminder.type === 'hourly') {
        const interval = setInterval(() => {
          triggerNotification(reminder);
        }, 60 * 60 * 1000); // Every hour
        
        reminderIntervals.push({ id: reminder.id, interval: interval });
      }
    }

    function triggerNotification(reminder) {
      console.log('üîî Triggering reminder:', reminder.task);
      
      // Try multiple notification methods for app compatibility
      let notificationSent = false;
      
      // Method 1: Browser notification (works in web browsers)
      if ('Notification' in window && Notification.permission === "granted") {
        try {
          new Notification(`WellNest Reminder: ${reminder.task}`, {
            body: `Time for: ${reminder.task}`,
            icon: 'images/fitness-logo.svg',
            badge: 'images/fitness-logo.svg',
            requireInteraction: true,
            tag: 'wellnest-reminder'
          });
          notificationSent = true;
          console.log('‚úÖ Browser notification sent');
        } catch (error) {
          console.log('‚ùå Browser notification failed:', error);
        }
      }

      // Method 2: App-specific notifications (for wrapped apps)
      if (typeof window.AndroidNotification !== 'undefined') {
        try {
          window.AndroidNotification.show(`WellNest Reminder: ${reminder.task}`);
          notificationSent = true;
          console.log('‚úÖ Android app notification sent');
        } catch (error) {
          console.log('‚ùå Android notification failed:', error);
        }
      }

      // Method 3: iOS app notifications
      if (typeof window.webkit !== 'undefined' && window.webkit.messageHandlers && window.webkit.messageHandlers.notification) {
        try {
          window.webkit.messageHandlers.notification.postMessage({
            title: 'WellNest Reminder',
            body: reminder.task
          });
          notificationSent = true;
          console.log('‚úÖ iOS app notification sent');
        } catch (error) {
          console.log('‚ùå iOS notification failed:', error);
        }
      }

      // Method 4: Vibration (for mobile apps)
      if ('vibrate' in navigator) {
        try {
          navigator.vibrate([200, 100, 200, 100, 200]);
          console.log('‚úÖ Vibration triggered');
        } catch (error) {
          console.log('‚ùå Vibration failed:', error);
        }
      }

      // Method 5: Audio alert (works in most environments)
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEfBzmByfLAciUEKH7J8t+QQAoTVrLr7aNWFAdGod/3um4gBDue2vTEcSEEJ4HM8t+RQgkRVrTs66hWFApGn+DyvmEfBzmByfLAciUEKH7J8t+QQAoUVrPp66hVFApGn+DyvmEfBzmByfLAciUEKH7J8t+QQAoTVrLr7aNWFAdGod/3um4gBDue2vTEcSEEJ4HM8t+RQgkRVrTs66hWFApGn+DyvmEfBzmByfLAciUEKH7J8t+QQAoUXrPq6qhWFAlDodnw');
        audio.volume = 0.7;
        audio.play().catch(() => console.log('‚ùå Audio alert failed'));
        console.log('‚úÖ Audio alert played');
      } catch (error) {
        console.log('‚ùå Audio setup failed:', error);
      }

      // Method 6: Visual alert (always works as fallback)
      showVisualAlert(reminder);
      
      // Method 7: Page title flash (works in background apps)
      flashPageTitle(reminder.task);
      
      // Log final status
      console.log(notificationSent ? '‚úÖ Notification successfully sent' : '‚ö†Ô∏è Using fallback visual alerts only');
    }

    function showVisualAlert(reminder) {
      // Create enhanced modal-style alert for app compatibility
      const alertDiv = document.createElement('div');
      alertDiv.className = 'reminder-alert app-compatible';
      alertDiv.innerHTML = `
        <div class="alert-overlay"></div>
        <div class="alert-content">
          <div class="alert-header">
            <span class="alert-icon">üîî</span>
            <h3>Reminder Time!</h3>
          </div>
          <div class="alert-body">
            <p class="reminder-task"><strong>${reminder.task}</strong></p>
            <p class="reminder-time">‚è∞ ${reminder.time === 'Test' ? 'Test Reminder' : formatTime(reminder.time)}</p>
            <p class="reminder-type">üìÖ ${reminder.type.charAt(0).toUpperCase() + reminder.type.slice(1)} reminder</p>
          </div>
          <div class="alert-actions">
            <button onclick="closeAlert(this)" class="alert-close-btn primary">‚úì Got it!</button>
            <button onclick="snoozeReminder(this, ${reminder.id})" class="alert-snooze-btn">‚è∞ Snooze 5min</button>
          </div>
        </div>
      `;
      document.body.appendChild(alertDiv);
      
      // Make the alert more prominent
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '0';
      alertDiv.style.left = '0';
      alertDiv.style.width = '100%';
      alertDiv.style.height = '100%';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.display = 'flex';
      alertDiv.style.alignItems = 'center';
      alertDiv.style.justifyContent = 'center';
      
      // Focus trap for accessibility
      const closeBtn = alertDiv.querySelector('.alert-close-btn');
      if (closeBtn) closeBtn.focus();
      
      // Auto-remove after 30 seconds (longer for app users)
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.parentNode.removeChild(alertDiv);
        }
      }, 30000);
    }

    function flashPageTitle(task) {
      const originalTitle = document.title;
      let flashCount = 0;
      const maxFlashes = 10;
      
      const flashInterval = setInterval(() => {
        document.title = flashCount % 2 === 0 ? `üîî REMINDER: ${task}` : originalTitle;
        flashCount++;
        
        if (flashCount >= maxFlashes) {
          clearInterval(flashInterval);
          document.title = originalTitle;
        }
      }, 1000);
    }

    function snoozeReminder(button, reminderId) {
      const alert = button.closest('.reminder-alert');
      if (alert && alert.parentNode) {
        alert.parentNode.removeChild(alert);
      }
      
      // Find the reminder and reschedule for 5 minutes later
      const reminder = activeReminders.find(r => r.id === reminderId);
      if (reminder) {
        setTimeout(() => {
          triggerNotification(reminder);
        }, 5 * 60 * 1000); // 5 minutes
        
        // Show confirmation
        const confirmDiv = document.createElement('div');
        confirmDiv.className = 'snooze-confirmation';
        confirmDiv.innerHTML = '<p>‚è∞ Reminder snoozed for 5 minutes</p>';
        confirmDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 10px 20px;
          border-radius: 5px;
          z-index: 10001;
          animation: slideIn 0.3s ease-out;
        `;
        document.body.appendChild(confirmDiv);
        
        setTimeout(() => {
          if (confirmDiv.parentNode) {
            confirmDiv.parentNode.removeChild(confirmDiv);
          }
        }, 3000);
      }
    }

    function closeAlert(button) {
      const alert = button.closest('.reminder-alert');
      if (alert && alert.parentNode) {
        alert.parentNode.removeChild(alert);
      }
    }

    function removeReminder(id) {
      // Remove from array
      activeReminders = activeReminders.filter(r => r.id !== id);
      
      // Clear any intervals
      const intervalObj = reminderIntervals.find(r => r.id === id);
      if (intervalObj) {
        clearInterval(intervalObj.interval);
        reminderIntervals = reminderIntervals.filter(r => r.id !== id);
      }
      
      // Remove from DOM
      const listItems = document.querySelectorAll('#reminderList li');
      listItems.forEach(item => {
        if (item.querySelector(`button[onclick="removeReminder(${id})"]`)) {
          item.remove();
        }
      });
      
      // Update localStorage
      localStorage.setItem('activeReminders', JSON.stringify(activeReminders));
    }

    function formatTime(time) {
      const [hours, minutes] = time.split(':');
      const hour12 = hours % 12 || 12;
      const ampm = hours >= 12 ? 'PM' : 'AM';
      return `${hour12}:${minutes} ${ampm}`;
    }

    function requestEnhancedNotificationPermission() {
      console.log('üîî Requesting enhanced notification permissions...');
      
      // Method 1: Standard web notification permission
      if ('Notification' in window) {
        if (Notification.permission === "default") {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              console.log('‚úÖ Web notifications granted');
            } else {
              console.log('‚ùå Web notifications denied');
              showNotificationFallbackInfo();
            }
          }).catch(error => {
            console.log('‚ùå Notification permission error:', error);
            showNotificationFallbackInfo();
          });
        }
      } else {
        console.log('‚ö†Ô∏è Web notifications not supported');
      }
      
      // Method 2: Request app-specific permissions
      if (typeof window.AndroidNotification !== 'undefined') {
        try {
          window.AndroidNotification.requestPermission();
          console.log('‚úÖ Android notification permission requested');
        } catch (error) {
          console.log('‚ùå Android permission request failed:', error);
        }
      }
      
      // Method 3: Request iOS app permissions
      if (typeof window.webkit !== 'undefined' && window.webkit.messageHandlers && window.webkit.messageHandlers.requestNotification) {
        try {
          window.webkit.messageHandlers.requestNotification.postMessage({});
          console.log('‚úÖ iOS notification permission requested');
        } catch (error) {
          console.log('‚ùå iOS permission request failed:', error);
        }
      }
    }

    function showNotificationFallbackInfo() {
      const infoDiv = document.createElement('div');
      infoDiv.className = 'notification-info';
      infoDiv.innerHTML = `
        <div class="info-content">
          <h4>üì± App Notifications</h4>
          <p>Reminders will work using:</p>
          <ul>
            <li>‚úì Visual alerts on screen</li>
            <li>‚úì Audio notifications</li>
            <li>‚úì Vibration (on mobile)</li>
            <li>‚úì Page title flashing</li>
          </ul>
          <button onclick="closeInfo(this)">Got it!</button>
        </div>
      `;
      infoDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 2px solid #4CAF50;
        border-radius: 10px;
        padding: 20px;
        z-index: 10002;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        max-width: 300px;
        text-align: center;
      `;
      document.body.appendChild(infoDiv);
      
      setTimeout(() => {
        if (infoDiv.parentNode) {
          infoDiv.parentNode.removeChild(infoDiv);
        }
      }, 8000);
    }

    function closeInfo(button) {
      const info = button.closest('.notification-info');
      if (info && info.parentNode) {
        info.parentNode.removeChild(info);
      }
    }

    // Load saved reminders and request notification permission
    window.addEventListener('load', () => {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
      
      // Load saved reminders
      const savedReminders = localStorage.getItem('activeReminders');
      if (savedReminders) {
        activeReminders = JSON.parse(savedReminders);
        activeReminders.forEach(reminder => {
          displayReminder(reminder);
          scheduleReminder(reminder);
        });
      }
    });
  </script>
</head>
<body>

<nav>
  <div class="logo-container">
    <img src="images/fitness-logo.svg" alt="WellNest Fitness Logo" />
    <h1>WellNest</h1>
  </div>
  
  <!-- Hamburger Menu Button -->
  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>
  
  <ul id="navMenu">
    <li><a href="index.html">Home</a></li>
    <li><a href="body.html">Body</a></li>
    <li><a href="bodyhealth.html">Body Health</a></li>
    <li><a href="mind.html">Mind</a></li>
    <li><a href="sleep.html">Sleep</a></li>
    <li><a href="diet.html">Diet</a></li>
    <li><a href="workout.html">Workout</a></li>
    <li><a href="care.html">Care</a></li>
    <li><a href="pray.html">Prayer</a></li>
    <li><a href="reminders.html" class="active">Reminders</a></li>
    <li><a href="login.html" id="loginLink">Login</a></li>
    <li><a href="signup.html" id="signupLink">Sign Up</a></li>
    <li><a href="#" onclick="logout()" id="logoutLink" style="display:none;">Logout üëã</a></li>
  </ul>
</nav>

<section class="section">
  <h2>Reminders & Weekly Summary ‚è∞</h2>
  <p>Stay consistent with your health routine!</p>

  <div class="card-container">
    <div class="card reminder-card">
      <h3>Set a Timed Reminder ‚è∞</h3>
      <div class="reminder-form">
        <input type="text" id="reminderInput" placeholder="E.g. Drink water, take medicine, exercise">
        <div class="time-input-group">
          <label for="reminderTime">Set Time:</label>
          <input type="time" id="reminderTime" required>
        </div>
        <div class="reminder-type">
          <label for="reminderType">Repeat:</label>
          <select id="reminderType">
            <option value="once">Once</option>
            <option value="daily">Daily</option>
            <option value="hourly">Every Hour</option>
          </select>
        </div>
        <button onclick="addTimedReminder()" class="add-reminder-btn">Add Reminder</button>
      </div>
      
      <div class="active-reminders">
        <h4>Active Reminders:</h4>
        <ul id="reminderList"></ul>
      </div>
    </div>

    <div class="card">
      <h3>Weekly Summary</h3>
      <p>‚úÖ 5 workouts completed<br>üíß 90% hydration goal<br>üò¥ Avg 7.5 hrs sleep<br>üßò‚Äç‚ôÄÔ∏è Mood: Happy</p>
    </div>
  </div>
</section>

<footer>¬© 2025 WellNest | Designed with üíö by Tahreem Fatima</footer>

<script>
  // Check authentication
  const isLoggedIn = localStorage.getItem('wellnest_user');
  if (!isLoggedIn || isLoggedIn !== 'true') {
    alert('üîí Please login to access your reminders! üåø');
    window.location.href = 'login.html';
  }

  // Update navigation
  function updateNavigation() {
    const isLoggedIn = localStorage.getItem('wellnest_user');
    if (isLoggedIn === 'true') {
      document.getElementById('loginLink').style.display = 'none';
      document.getElementById('signupLink').style.display = 'none';
      document.getElementById('logoutLink').style.display = 'block';
    }
  }

  function logout() {
    localStorage.removeItem('wellnest_user');
    localStorage.removeItem('wellnest_user_data');
    localStorage.removeItem('activeReminders');
    alert('Logged out successfully! See you soon! üëã');
    window.location.href = 'index.html';
  }

  // Initialize navigation
  updateNavigation();

  // Register service worker for PWA functionality
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('SW registered: ', registration);
        })
        .catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
    });
  }

  // Hamburger Menu Functionality
  const hamburger = document.getElementById('hamburger');
  const navMenu = document.getElementById('navMenu');

  hamburger.addEventListener('click', () => {
    hamburger.classList.toggle('active');
    navMenu.classList.toggle('active');
  });

  // Close menu when clicking on a link
  document.querySelectorAll('#navMenu a').forEach(link => {
    link.addEventListener('click', () => {
      hamburger.classList.remove('active');
      navMenu.classList.remove('active');
    });
  });
</script>
</body>
</html>
